# Loop pipelining in MLIR

This experimental branch contains the code to perform loop pipelining at the affine level, as described in our [IMPACT paper](https://acohen.gitlabpages.inria.fr/impact/impact2022/papers/paper1.pdf). The required MLIR passes have not yet been integrated in the soda-opt default pipeline, so here are instructions on how to use them.

All steps require the user to specify **how many innermost loops need to be pipelined**. There is currently no way to identify a specific loop, each pass will go through the code sequentially and work on the number of loops specified through the `loop` **pass option**.

Assuming a file `input.mlir` exists and it contains (at least) one affine for loop:

* First step: forward results. This pass removes unnecessary load/store operations, using yield operations and iteration arguments to forward results from an iteration to the following one.

`soda-opt -pass-pipeline="func.func(test-forward-results {loop=1})" input.mlir -o input_forwarded.mlir`

* Second step: if conversion. This pass transforms the loop body when it contains if/else blocks, so that it can be pipelined.

`soda-opt -pass-pipeline="func.func(test-if-conversion {loop=1})" input_forwarded.mlir -o input_converted.mlir`

* Third step: Data Flow Graph extraction. This pass analyzes the loop body to understand operation dependencies.

`soda-opt -pass-pipeline="func.func(test-data-flow-graph {loop=1})" input_converted.mlir`

* Fourth step: creation of a schedule. This is the only step that requires an **external tool**, we used [HatSchet](https://digidev.digi.e-technik.uni-kassel.de/hatschet/). If a different tool is used, **steps 3 and 5 will need to be modified** to generate the DFG and read the schedule in different formats.

* Fifth step: loop transformation. Taking the scedule generated by the external tool in step 4, this pass reconstructs the loop so that its operations are independent, adding prologue and epilogue.

`soda-opt -pass-pipeline="func.func(test-loop-scheduling {schedule=schedule.csv loop=1})" input_converted.mlir -o input_pipelined.mlir"`